# 技术架构文档

## 🏗️ 整体架构

### 分层设计
```
┌─────────────────────────────────────────────────────────────┐
│                     应用层 (Application)                     │
│  策略引擎  │  订单管理  │  风险控制  │  监控告警           │
├─────────────────────────────────────────────────────────────┤
│                     服务层 (Service)                        │
│  交易服务  │  数据服务  │  配置服务  │  通知服务           │
├─────────────────────────────────────────────────────────────┤
│                     接入层 (Gateway)                        │
│  Binance   │    OKX     │   Gate     │  WebSocket          │
├─────────────────────────────────────────────────────────────┤
│                     存储层 (Storage)                        │
│ PostgreSQL │   Redis    │  文件存储  │  日志存储           │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 核心组件

### 1. 策略引擎 (Strategy Engine)
**职责**: 交易策略执行和信号生成

**核心类**:
```rust
pub struct MarketMakingStrategy {
    config: StrategyConfig,
    position: Position,
    orders: OrderManager,
}

impl Strategy for MarketMakingStrategy {
    async fn on_market_data(&mut self, data: MarketData) -> Vec<Order>;
    async fn on_order_update(&mut self, update: OrderUpdate);
}
```

**关键特性**:
- 双边报价算法
- 库存偏差调整
- 动态价差管理
- 风险限制检查

### 2. 订单管理系统 (OMS)
**职责**: 订单生命周期管理和交易所适配

**核心接口**:
```rust
#[async_trait]
pub trait ExchangeAdapter {
    async fn place_order(&self, order: &Order) -> Result<OrderResponse>;
    async fn cancel_order(&self, id: &str) -> Result<OrderResponse>;
    async fn get_balance(&self) -> Result<Vec<Balance>>;
}
```

**实现类**:
- `BinanceAdapter`: Binance API 适配
- `OkxAdapter`: OKX API 适配  
- `GateAdapter`: Gate API 适配

### 3. 风险管理系统 (RMS)
**职责**: 实时风险监控和控制

**风险检查**:
```rust
pub struct RiskManager {
    position_limits: PositionLimits,
    order_limits: OrderLimits,
    pnl_limits: PnLLimits,
}

impl RiskManager {
    pub fn check_order(&self, order: &Order) -> RiskResult;
    pub fn check_position(&self, position: &Position) -> RiskResult;
}
```

**控制机制**:
- 持仓限制
- 订单频率限制
- 日内损失限制
- 紧急停止机制

### 4. 数据管理
**职责**: 市场数据接收和历史数据存储

**数据流**:
```
WebSocket → 数据解析 → 标准化 → 策略引擎
    ↓
历史存储 ← 批处理 ← 数据缓冲
```

**存储结构**:
- 实时数据: Redis 缓存
- 历史数据: PostgreSQL 分区表
- 日志数据: 文件系统

## 📊 数据模型

### 核心数据结构

#### 订单 (Order)
```rust
pub struct Order {
    pub id: String,
    pub symbol: Symbol,
    pub side: OrderSide,      // Buy/Sell
    pub order_type: OrderType, // Market/Limit
    pub quantity: Decimal,
    pub price: Option<Decimal>,
    pub status: OrderStatus,
    pub timestamp: DateTime<Utc>,
}
```

#### 市场数据 (MarketData)
```rust
pub struct MarketData {
    pub symbol: Symbol,
    pub bid: Decimal,
    pub ask: Decimal,
    pub last_price: Decimal,
    pub volume: Decimal,
    pub timestamp: DateTime<Utc>,
}
```

#### 持仓 (Position)
```rust
pub struct Position {
    pub symbol: Symbol,
    pub quantity: Decimal,
    pub average_price: Decimal,
    pub unrealized_pnl: Decimal,
    pub realized_pnl: Decimal,
}
```

## 🔄 数据流设计

### 1. 市场数据流
```
交易所 WebSocket → 数据解析器 → 标准化处理 → 策略引擎
                                      ↓
                              Redis 缓存 → PostgreSQL
```

### 2. 订单执行流
```
策略信号 → 风险检查 → 订单生成 → 交易所 API → 状态更新
    ↓           ↓          ↓           ↓          ↓
  日志记录   风险监控   订单存储   执行确认   持仓更新
```

### 3. 配置管理流
```
配置文件 → 配置解析 → 参数验证 → 运行时配置 → 动态更新
    ↓          ↓          ↓          ↓          ↓
  版本控制   格式检查   范围检查   内存加载   热更新
```

## ⚡ 性能优化

### 1. 异步处理
- 基于 Tokio 的异步运行时
- 非阻塞 I/O 操作
- 并发任务调度

### 2. 内存管理
- 零拷贝数据传输
- 对象池重用
- 智能指针管理

### 3. 网络优化
- HTTP/2 连接复用
- WebSocket 长连接
- 请求批处理

### 4. 数据库优化
- 连接池管理
- 批量写入
- 索引优化
- 分区表设计

## 🔒 安全架构

### 1. API 安全
```rust
pub struct ApiSigner {
    api_key: String,
    secret_key: String,
}

impl ApiSigner {
    pub fn sign_request(&self, request: &Request) -> String {
        // HMAC-SHA256 签名
    }
}
```

### 2. 数据安全
- 敏感数据加密存储
- 传输层 TLS 加密
- 访问权限控制

### 3. 系统安全
- 输入参数验证
- SQL 注入防护
- 异常处理机制

## 📈 监控体系

### 1. 系统监控
- CPU/内存使用率
- 网络延迟和吞吐量
- 磁盘 I/O 性能

### 2. 业务监控
- 订单成功率
- 策略收益率
- 风险指标

### 3. 告警机制
- 阈值告警
- 异常检测
- 自动恢复

## 🚀 部署架构

### 1. 单机部署
```
┌─────────────────────────────────────┐
│            服务器                    │
│  ┌─────────┐  ┌─────────┐          │
│  │ HFT App │  │Database │          │
│  └─────────┘  └─────────┘          │
└─────────────────────────────────────┘
```

### 2. 分布式部署
```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  策略节点    │  │  数据节点    │  │  存储节点    │
│ Strategy    │  │   Data      │  │  Storage    │
│  Service    │  │  Service    │  │  Service    │
└─────────────┘  └─────────────┘  └─────────────┘
       │               │               │
┌─────────────────────────────────────────────────┐
│              负载均衡器                          │
└─────────────────────────────────────────────────┘
```

## 🔧 配置管理

### 配置层级
1. **默认配置**: 系统内置默认值
2. **文件配置**: config.toml 配置文件
3. **环境变量**: 运行时环境配置
4. **动态配置**: 运行时动态调整

### 配置示例
```toml
[system]
log_level = "info"
worker_threads = 4

[database]
url = "postgresql://localhost/hft"
pool_size = 10

[strategy]
enabled = true
risk_limit = 1000.0
```

---

**架构版本**: v1.0  
**最后更新**: 2025-01-01

